<?php 

$input = $this->input->post();

$user = $this->data['userdata'];

$id = $input['id'];

$query = $this->Vendor_m->getVendor($id)->row_array();
$activity = $this->Workflow_m->getActivity($input['activity_id'])->row_array();
$response = $this->Workflow_m->getResponse($input['status_inp'][0])->row_array();
$next_pos = $this->Administration_m->getPosbyJob("APPROVAL VENDOR")->row_array();

$data_pq_header = array(
	"vendor_id" => $input['id'],
	"vtm_id" => $input['vnd_type_inp'],
	"avd_id" => $input['template_inp'],
	'vdp_pos_id' => $user['pos_id'],
	"vdp_status" => 0,
	"created_datetime" => date('Y-m-d H:i:s')
);


$vendor_com = [
	'vendor_id' => $input['id'],
	'vc_position' => $user['pos_id'],
	'vc_name' => $user['complete_name'],
	'vc_activity' => $activity['awa_name'],
	'vc_activity_code' => $input['activity_id'],
	'vc_start_date' => date("Y-m-d H:i:s"),
	'vc_end_date' => date("Y-m-d H:i:s"),
	'vc_response' => $response['awr_name'],
	'vc_comment' => $input['comment_inp'][0],
	'vc_attachment' =>'',
	'vc_next_pos_code' => $next_pos['pos_id'],
	'vc_next_pos_name' => $next_pos['pos_name']
];



$this->db->trans_begin();

//insert vnd doc pq header
//return last id
$insertVndDocPq = $this->Vendor_m->insertVndDocPq($data_pq_header);

if ($insertVndDocPq) {

	$doc_pq_comment = [
	  "vdpc_position" => $user['pos_id'],
	  "vdp_id" => $insertVndDocPq,
	  "vdpc_pos_name" => $user['pos_name'],
	  "vdpc_name" => $user['complete_name'],
	  "vdpc_activity" => "Permintaan upload dokumen PQ/Tambahan",
	  "vdpc_start_date" => date("Y-m-d H:i:s"),
	  "vdpc_end_date" => date("Y-m-d H:i:s"),
	  "vdpc_response" => "-",
	  "vdpc_comment" => "Silahkan Upload Dokumen PQ/Tambahan (Generated By System)",
	  // "vdpc_attachment" ,
	  // "vdpc_next_pos_code" ,
	  // "vdpc_next_pos_name" ,
	  // "vdpc_activity_code" int4,
	];

	$doc_pq_com = $this->Comment_m->insertDocPQ($doc_pq_comment);
}

$data['state_now'] = $input['survey_inp'];
$data['survey_recom'] = ($input['survey_inp'] == 3) ? (!empty($input['doc_attachment_inp']) ? $input['doc_attachment_inp'] : 'R') : 'NR';

$act = $this->Vendor_m->updateVendor($id, $data);

$com = $this->Comment_m->insertVendor($vendor_com);


if ($this->db->trans_status() === FALSE){
	$this->setMessage("Gagal mengubah data");
	$this->db->trans_rollback();
}else{
	$this->setMessage("Berhasil mengubah data");
	$this->db->trans_commit();

	$msg = "Dengan hormat,
		<br/>
		<br/>
		Bersama ini kami sampaikan bahwa ".COMPANY_NAME." sedang memverifikasi akun Anda.
		Silahkan upload dokumen PQ/tambahan melalui <a href='".EXTRANET_URL."' target='_blank'>eSCM ".COMPANY_NAME."</a> sebagai syarat untuk mengaktivasi akun Anda.
		<br/>
		<br/>
		Terimakasih,
		<br/>
		".COMPANY_NAME;

		$email = $this->sendEmail($getEmailVendor,"Pemberitahuan Aktivasi Vendor eSCM".COMPANY_NAME,$msg);
}


redirect(site_url('vendor/daftar_pekerjaan'));